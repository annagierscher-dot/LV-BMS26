/*
 * DS2484.h
 *
 *  Created on: Jul 6, 2023
 *      Author: Jake
 */

#ifndef INC_DS2484_H_
#define INC_DS2484_H_

#include "main.h"
#include "i2c.h"
#include "freertos_os2.h"
#include "task.h"


int DS2484_IsAvailable(void);


#define	DS18B20_RESOLTUTION 12			//in Bit
#define NUM_TOTAL_TEMP_SENS 12




/* Defines */

/* I2C-Commands */
#define CMD_DRST		0xF0
#define CMD_WCFG		0xD2
#define CMD_CHSL		0xC3
#define CMD_SRP			0xE1
#define CMD_1WRS		0xB4
#define CMD_1WWB		0xA5
#define CMD_1WRB		0x96
#define CMD_1WSB		0x87
#define CMD_1WT			0x78

#define OWsearchROM	    0xF0
#define OWreadROM		0x33
#define	OWmatchROM	    0x55
#define	OWskipROM		0xCC
#define	OWalarmSearch	0xEC
#define	OWconvertTemp	0x44
#define	OWwriteScratchpad	0x4E
#define	OWreadSchratchpad	0xBE


#define DS2482_Adress		0b00110000
#define I2C_WRITE		0
#define I2C_READ		1

#define POLL_LIMIT	500

#define STATUS_1WB	0b00000001
#define STATUS_PPD	0b00000010
#define STATUS_SD   0b00000100
#define STATUS_SBR	0b00100000

/* DS18B20 Adresses */

static const uint8_t ROM[12][8] =
{
	{0x28, 0xCC, 0xF4, 0xFE, 0x0B, 0x00, 0x00, 0xE0},		//01
	{0x28, 0x77, 0xF8, 0xFE, 0x0B, 0x00, 0x00, 0x3E},		//02
	{0x28, 0x3B, 0xD5, 0xFD, 0x0B, 0x00, 0x00, 0xAA},		//03
	{0x28, 0xC5, 0xFF, 0xFE, 0x0B, 0x00, 0x00, 0x06},		//04
	{0x28, 0x9F, 0xDA, 0xFB, 0x0B, 0x00, 0x00, 0x4C},		//05
	{0x28, 0x68, 0xC2, 0xFD, 0x0B, 0x00, 0x00, 0xF0},		//06
	{0x28, 0x38, 0xC8, 0xFB, 0x0B, 0x00, 0x00, 0x6A},		//07
	{0x28, 0xDE, 0xDA, 0xFE, 0x0B, 0x00, 0x00, 0x8F},		//08
	{0x28, 0x89, 0x32, 0xFC, 0x0B, 0x00, 0x00, 0xC7},		//09
	{0x28, 0xAE, 0x17, 0xFD, 0x0B, 0x00, 0x00, 0x51},		//10
	{0x28, 0xDF, 0xE3, 0xFE, 0x0B, 0x00, 0x00, 0xCF},		//11
	{0x28, 0xC1, 0xD6, 0xFB, 0x0B, 0x00, 0x00, 0x50},		//12

};


static const uint8_t ROM1[17][8] = {
		{0x28, 0xCC, 0xF4, 0xFE, 0x0B, 0x00, 0x00, 0xE0},		//01
		{0x28, 0x77, 0xF8, 0xFE, 0x0B, 0x00, 0x00, 0x3E},		//02
		{0x28, 0x3B, 0xD5, 0xFD, 0x0B, 0x00, 0x00, 0xAA},		//03
		{0x28, 0xC5, 0xFF, 0xFE, 0x0B, 0x00, 0x00, 0x06},		//04
		{0x28, 0x9F, 0xDA, 0xFB, 0x0B, 0x00, 0x00, 0x4C},		//05
		{0x28, 0x68, 0xC2, 0xFD, 0x0B, 0x00, 0x00, 0xF0},		//06
		{0x28, 0x38, 0xC8, 0xFB, 0x0B, 0x00, 0x00, 0x6A},		//07
		{0x28, 0xDE, 0xDA, 0xFE, 0x0B, 0x00, 0x00, 0x8F},		//08
		{0x28, 0x89, 0x32, 0xFC, 0x0B, 0x00, 0x00, 0xC7},		//09
		{0x28, 0xAE, 0x17, 0xFD, 0x0B, 0x00, 0x00, 0x51},		//10
		{0x28, 0xDF, 0xE3, 0xFE, 0x0B, 0x00, 0x00, 0xCF},		//11
		{0x28, 0xC1, 0xD6, 0xFB, 0x0B, 0x00, 0x00, 0x50},
};


/* Prototypes */
uint8_t DS2482_detect(unsigned char addr);
uint8_t DS2482_reset();
uint8_t DS2482_write_config(unsigned char config);
uint8_t DS2482_channel_select(int channel);
uint8_t OWReset(void);
unsigned char OWTouchBit(unsigned char sendbit);
void OWWriteByte(unsigned char sendbyte);
unsigned char OWReadByte(void);
void OWBlock(unsigned char *tran_buf, int tran_len);
unsigned char OWTouchByte(unsigned char sendbyte);
void set_resolution(uint8_t res, uint8_t tHigh, uint8_t tLow);
void DS2482_Task(float *temps, uint64_t *roms);
void DS2482_performsearch(uint64_t *rom_addresses_found);
void EvaluateCellTemps(uint16_t * ptemps, uint16_t * pminTemp, uint16_t * pavgTemp, uint16_t * pmaxTemp, uint8_t * pminNum, uint8_t * pmaxNum);



#endif /* INC_DS2484_H_ */
